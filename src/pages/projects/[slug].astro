---
import { getCollection, type CollectionEntry } from "astro:content";
import { readFile, readdir } from "node:fs/promises";
import SectionsLayout from "../../layouts/SectionsLayout.astro";

export async function getStaticPaths() {
	const projects = await getCollection("featuredProjects");

	return projects.map((project) => ({
		params: { slug: project.slug },
		props: { project },
	}));
}

interface Props {
	project: CollectionEntry<"featuredProjects">;
}

const { project } = Astro.props as Props;

const IMAGE_EXTENSIONS = /\.(avif|gif|jpe?g|png|webp)$/i;
const SPAN_PATTERN: Array<"sm" | "md" | "lg"> = ["md", "sm", "lg", "md", "sm", "md"];

const projectFolderUrl = new URL(`../../../public/images/projects/${project.slug}/`, import.meta.url);

const formatCaption = (filename: string) =>
	filename
		.replace(/\.[^.]+$/, "")
		.replace(/[._]+/g, " ")
		.replace(/\s+/g, " ")
		.trim();

const sortByFileName = (a: string, b: string) =>
	a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" });

const buildProjectImages = async () => {
	try {
		const entries = await readdir(projectFolderUrl, { withFileTypes: true });
		const imageFiles = entries
			.filter((entry) => entry.isFile() && IMAGE_EXTENSIONS.test(entry.name))
			.map((entry) => entry.name)
			.sort(sortByFileName);

		if (imageFiles.length === 0) {
			return project.data.images;
		}

		return imageFiles.map((filename, index) => ({
			src: `/images/projects/${project.slug}/${filename}`,
			alt: `${project.data.title} photo ${index + 1}`,
			caption: formatCaption(filename),
			span: SPAN_PATTERN[index % SPAN_PATTERN.length],
		}));
	} catch {
		return project.data.images;
	}
};

const readProjectTeaser = async () => {
	try {
		const plain = await readFile(new URL("teaser.txt", projectFolderUrl), "utf-8");
		const clean = plain.trim();
		if (clean) return clean;
	} catch {
		// Fallback to rich text if plain text is not available.
	}

	try {
		const rich = await readFile(new URL("teaser.txt.rtf", projectFolderUrl), "utf-8");
		const decoded = rich
			.replace(/\\par[d]?/g, "\n")
			.replace(/\\\r?\n/g, "\n")
			.replace(/\\[a-z]+\d* ?/gi, "")
			.replace(/[{}]/g, "")
			.replace(/\n{3,}/g, "\n\n")
			.trim();

		if (decoded) return decoded;
	} catch {
		// Keep frontmatter teaser if no local file is found.
	}

	return project.data.teaser;
};

const teaser = await readProjectTeaser();
const projectImages = await buildProjectImages();
const heroFallbackSrc = projectImages[0]?.src ?? project.data.cover;
---

<SectionsLayout title={`${project.data.title} | isidoro pannitti architetto`} section="architecture">
	<article class="project-page">
		<figure class="hero">
			<img
				src={project.data.cover}
				alt={project.data.coverAlt}
				loading="eager"
				fetchpriority="high"
				decoding="sync"
				onerror={`this.onerror=null;this.src='${heroFallbackSrc}'`}
			/>
			<figcaption>
				{project.data.coverCaption}
				{project.data.status && <span class="status-tag">{project.data.status}</span>}
			</figcaption>
		</figure>

		{teaser && <p class="teaser">{teaser}</p>}

		<ul class="project-grid" aria-label={`${project.data.title} gallery`}>
			{
				projectImages.map((image) => (
					<li class:list={["grid-item", `span-${image.span}`]}>
						<figure>
							<img src={image.src} alt={image.alt} loading="lazy" decoding="async" />
							<figcaption>{image.caption}</figcaption>
						</figure>
					</li>
				))
			}
		</ul>
	</article>
</SectionsLayout>

<style>
	.project-page {
		max-width: 100%;
	}

	.hero {
		margin: 0;
		display: grid;
		gap: 0.45rem;
	}

	.hero img {
		width: 17rem;
		height: auto;
		display: block;
	}

	.hero figcaption {
		display: flex;
		align-items: baseline;
		gap: 0.55rem;
	}

	.status-tag {
		font-style: italic;
	}

	.teaser {
		max-width: 26rem;
		margin: 0.65rem 0 0;
		white-space: pre-line;
	}

	.project-grid {
		list-style: none;
		padding: 0;
		margin: clamp(2rem, 7vh, 3.5rem) 0 0;
		display: grid;
		grid-template-columns: minmax(0, 1fr) minmax(3.5rem, 18vw) minmax(0, 1fr);
		column-gap: clamp(1.5rem, 4vw, 3.5rem);
		row-gap: clamp(2.8rem, 9vh, 6.5rem);
	}

	.grid-item {
		margin: 0;
		grid-column: 1;
		justify-self: start;
		width: min(100%, clamp(14rem, 24vw, 23rem));
	}

	.grid-item figure {
		margin: 0;
		display: grid;
		gap: 0.45rem;
	}

	.grid-item img {
		width: 100%;
		height: auto;
		display: block;
	}

	.grid-item:nth-child(even) {
		grid-column: 3;
		justify-self: end;
	}

	@media (max-width: 980px) {
		.hero img {
			width: 22rem;
		}

		.project-grid {
			grid-template-columns: 1fr;
			row-gap: clamp(2rem, 6vh, 3.2rem);
		}

		.grid-item,
		.grid-item:nth-child(even) {
			grid-column: 1;
			justify-self: start;
			width: min(100%, clamp(16rem, 72vw, 24rem));
		}
	}
</style>
