---
import { getCollection, type CollectionEntry } from "astro:content";
import { readFile, readdir } from "node:fs/promises";
import SectionsLayout from "../../layouts/SectionsLayout.astro";

export async function getStaticPaths() {
	const projects = await getCollection("featuredProjects");

	return projects.map((project) => ({
		params: { slug: project.slug },
		props: { project },
	}));
}

interface Props {
	project: CollectionEntry<"featuredProjects">;
}

const { project } = Astro.props as Props;

const IMAGE_EXTENSIONS = /\.(avif|gif|jpe?g|png|webp)$/i;
const SPAN_PATTERN: Array<"sm" | "md" | "lg"> = ["md", "sm", "lg", "md", "sm", "md"];

const projectFolderUrl = new URL(`../../../public/images/projects/${project.slug}/`, import.meta.url);

const formatCaption = (filename: string) =>
	filename
		.replace(/\.[^.]+$/, "")
		.replace(/[._]+/g, " ")
		.replace(/\s+/g, " ")
		.trim();

const sortByFileName = (a: string, b: string) =>
	a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" });

const buildProjectImages = async () => {
	try {
		const entries = await readdir(projectFolderUrl, { withFileTypes: true });
		const imageFiles = entries
			.filter((entry) => entry.isFile() && IMAGE_EXTENSIONS.test(entry.name))
			.map((entry) => entry.name)
			.sort(sortByFileName);

		if (imageFiles.length === 0) {
			return project.data.images;
		}

		return imageFiles.map((filename, index) => ({
			src: `/images/projects/${project.slug}/${filename}`,
			alt: `${project.data.title} photo ${index + 1}`,
			caption: formatCaption(filename),
			span: SPAN_PATTERN[index % SPAN_PATTERN.length],
		}));
	} catch {
		return project.data.images;
	}
};

const readProjectTeaser = async () => {
	try {
		const plain = await readFile(new URL("teaser.txt", projectFolderUrl), "utf-8");
		const clean = plain.trim();
		if (clean) return clean;
	} catch {
		// Fallback to rich text if plain text is not available.
	}

	try {
		const rich = await readFile(new URL("teaser.txt.rtf", projectFolderUrl), "utf-8");
		const decoded = rich
			.replace(/\\par[d]?/g, "\n")
			.replace(/\\\r?\n/g, "\n")
			.replace(/\\[a-z]+\d* ?/gi, "")
			.replace(/[{}]/g, "")
			.replace(/\n{3,}/g, "\n\n")
			.trim();

		if (decoded) return decoded;
	} catch {
		// Keep frontmatter teaser if no local file is found.
	}

	return project.data.teaser;
};

const teaser = await readProjectTeaser();
const projectImages = await buildProjectImages();
const heroFallbackSrc = projectImages[0]?.src ?? project.data.cover;

const arrangedProjectImages: Array<
	(typeof projectImages)[number] & { column: "left" | "right"; row: number }
> = [];

let rowCursor = 1;
const totalPairs = Math.ceil(projectImages.length / 2);

for (let pairIndex = 0; pairIndex < totalPairs; pairIndex += 1) {
	const leftImage = projectImages[pairIndex * 2];
	const rightImage = projectImages[pairIndex * 2 + 1];

	let leftRow = rowCursor;
	let rightRow = rowCursor;

	// Occasional unilateral skip to keep rhythm while preserving order.
	if (pairIndex % 4 === 1) {
		rightRow += 1;
	}
	if (pairIndex % 4 === 3) {
		leftRow += 1;
	}

	if (leftImage) {
		arrangedProjectImages.push({
			...leftImage,
			column: "left",
			row: leftRow,
		});
	}
	if (rightImage) {
		arrangedProjectImages.push({
			...rightImage,
			column: "right",
			row: rightRow,
		});
	}

	// Keep one whole empty row between consecutive pairs.
	rowCursor = Math.max(leftRow, rightRow) + 2;

	// Add an additional empty row periodically for a slower vertical rhythm.
	if ((pairIndex + 1) % 3 === 2) {
		rowCursor += 1;
	}
}
---

<SectionsLayout title={`${project.data.title} | isidoro pannitti architetto`} section="architecture">
	<article class="project-page">
		<div class="hero-head">
			<figure class="hero">
				<img
					src={project.data.cover}
					alt={project.data.coverAlt}
					loading="eager"
					fetchpriority="high"
					decoding="sync"
					onerror={`this.onerror=null;this.src='${heroFallbackSrc}'`}
				/>
				<figcaption>
					{project.data.coverCaption}
					{project.data.status && <span class="status-tag">{project.data.status}</span>}
				</figcaption>
			</figure>

			{teaser && <p class="teaser teaser-inline">{teaser}</p>}
		</div>

		<ul class="project-grid" aria-label={`${project.data.title} gallery`}>
			{
				arrangedProjectImages.map((image) => (
					<li
						class:list={["grid-item", image.column === "right" && "is-right"]}
						style={`--grid-col:${image.column === "left" ? 1 : 3}; --grid-row:${image.row};`}
					>
						<figure>
							<img src={image.src} alt={image.alt} loading="lazy" decoding="async" />
							<figcaption>{image.caption}</figcaption>
						</figure>
					</li>
				))
			}
		</ul>
	</article>
</SectionsLayout>

<style>
	.project-page {
		max-width: 100%;
	}

	.hero {
		margin: 0;
		display: grid;
		gap: 0.45rem;
	}

	.hero-head {
		display: grid;
		grid-template-columns: 17rem minmax(16rem, 32rem);
		align-items: start;
		column-gap: clamp(1.8rem, 4.5vw, 5rem);
	}

	.hero img {
		width: 17rem;
		height: auto;
		display: block;
	}

	.hero figcaption {
		display: flex;
		align-items: baseline;
		gap: 0.55rem;
	}

	.status-tag {
		font-style: italic;
	}

	.teaser {
		max-width: 26rem;
		margin: 0.65rem 0 0;
		white-space: pre-line;
	}

	.teaser-inline {
		margin: 0;
		max-width: clamp(16rem, 30vw, 32rem);
	}

	.project-grid {
		list-style: none;
		padding: 0;
		margin: clamp(2rem, 7vh, 3.5rem) 0 0;
		display: grid;
		--project-col: clamp(14rem, 22vw, 21rem);
		--project-gap-col: clamp(14rem, 22vw, 21rem);
		grid-template-columns: var(--project-col) var(--project-gap-col) var(--project-col);
		justify-content: start;
		column-gap: clamp(1.4rem, 3.5vw, 2.8rem);
		row-gap: clamp(3.6rem, 11vh, 8rem);
	}

	.grid-item {
		margin: 0;
		grid-column: var(--grid-col, 1);
		grid-row: var(--grid-row, auto);
		justify-self: start;
		width: 100%;
	}

	.grid-item figure {
		margin: 0;
		display: grid;
		gap: 0.45rem;
	}

	.grid-item img {
		width: 100%;
		height: auto;
		display: block;
	}

	.grid-item.is-right {
		justify-self: end;
	}

	@media (max-width: 980px) {
		.hero-head {
			grid-template-columns: 1fr;
			row-gap: 0.65rem;
		}

		.hero img {
			width: 22rem;
		}

		.project-grid {
			grid-template-columns: 1fr;
			row-gap: clamp(2rem, 6vh, 3.2rem);
		}

		.grid-item {
			grid-column: 1;
			grid-row: auto;
			justify-self: start;
			width: min(100%, clamp(16rem, 72vw, 24rem));
		}
	}
</style>
